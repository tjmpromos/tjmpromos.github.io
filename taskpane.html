<!-- Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT License. -->
<!DOCTYPE html>
<html>

<head>
    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>

<body>
    <button id="jobcc" style="display:none;">Add job+ to ccRecipients</button>
</body>

<script>
    Office.onReady((info) => {
        if (info.host === Office.HostType.Outlook) {
            document.getElementById("jobcc").onclick = addJobToCc;
            addJobToCc();
        }
    });

    async function addJobToCc() {
        function extractJobNumber(text) {
            var match = text.match(/\b(300\d{6})\b/);
            return match ? match[1] : null;
        }

        let existingBox = document.getElementById("jobNumberBoxContainer");
        if (existingBox) existingBox.remove();

        // Get the domain from the original "To" header if available, otherwise fall back to To or From
        getDomainFromOriginalTo(function(err, domain, originalToAddress) {
            if (domain) {
                var Username = Office.context.mailbox.userProfile.displayName || Office.context.mailbox.userProfile.emailAddress;

                // Immediately set the From address to the current user at the discovered domain
                setFromToDomain(domain);

                Office.context.mailbox.item.subject.getAsync(function(subjectResult) {
                    var subject = (subjectResult.status === Office.AsyncResultStatus.Succeeded && subjectResult.value) ? subjectResult.value : "";

                    Office.context.mailbox.item.body.getAsync(Office.CoercionType.Text, function(bodyResult) {
                        var body = (bodyResult.status === Office.AsyncResultStatus.Succeeded && bodyResult.value) ? bodyResult.value : "";

                        var jobNumber = extractJobNumber(subject) || extractJobNumber(body);

                        if (!jobNumber) {
                            var container = document.createElement("div");
                            container.id = "jobNumberBoxContainer";
                            container.style.marginTop = "10px";

                            var label = document.createElement("label");
                            label.htmlFor = "jobNumberBox";
                            label.innerText = "Enter job number: ";
                            container.appendChild(label);

                            var input = document.createElement("input");
                            input.type = "text";
                            input.id = "jobNumberBox";
                            input.maxLength = 9;
                            input.pattern = "300[0-9]{6}";
                            input.style.marginRight = "8px";
                            container.appendChild(input);

                            var btn = document.createElement("button");
                            btn.innerText = "Add CC";
                            btn.onclick = function() {
                                var val = input.value.trim();
                                if (/^300\d{6}$/.test(val)) {
                                    addJobCcWithNumber(val, domain);
                                    container.remove();
                                    if (Office.context.ui && Office.context.ui.closeContainer) {
                                        Office.context.ui.closeContainer();
                                    }
                                } else {
                                    input.style.borderColor = "red";
                                    input.focus();
                                }
                            };
                            container.appendChild(btn);

                            input.addEventListener("keydown", function(e) {
                                if (e.key === "Enter") {
                                    btn.click();
                                }
                            });

                            document.body.appendChild(container);
                            input.focus();
                            return;
                        }

                        addJobCcWithNumber(jobNumber, domain);
                        setFromAddress(Username, domain);
                    });
                });
            } else {
                writeToBody("Could not get the original 'to' address.");
                if (Office.context.ui && Office.context.ui.closeContainer) {
                    Office.context.ui.closeContainer();
                }
            }
        });
    }

    function getDomainFromOriginalTo(callback) {
        // Try to read internet headers (Original-To, X-Original-To, Delivered-To, Resent-To, To)
        if (Office.context.mailbox.item.getAllInternetHeadersAsync) {
            Office.context.mailbox.item.getAllInternetHeadersAsync(function(headerResult) {
                if (headerResult.status === Office.AsyncResultStatus.Succeeded && headerResult.value) {
                    var headers = headerResult.value;
                    // Look for common headers that carry the original recipient
                    var headerMatch = headers.match(/^(?:Original-To|X-Original-To|Delivered-To|Resent-To|To):\s*(.+)$/gim);
                    if (headerMatch && headerMatch.length > 0) {
                        // Extract email address from the first matching header
                        var first = headerMatch[0];
                        var addrMatch = first.match(/([A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,})/i);
                        if (addrMatch) {
                            var address = addrMatch[1];
                            var domain = address.substring(address.indexOf('@') + 1);
                            callback(null, domain, address);
                            return;
                        }
                    }
                }
                // If headers didn't yield a domain, fall back
                fallbackToRecipient();
            });
            return;
        }

        // Fallback path: use To, then From
        fallbackToRecipient();

        function fallbackToRecipient() {
            Office.context.mailbox.item.to.getAsync(function(res) {
                if (res.status === Office.AsyncResultStatus.Succeeded && res.value && res.value.emailAddress) {
                    var address = res.value.emailAddress;
                    var domain = address.substring(address.indexOf('@') + 1);
                    callback(null, domain, address);
                } else {
                    Office.context.mailbox.item.from.getAsync(function(fromRes) {
                        if (fromRes.status === Office.AsyncResultStatus.Succeeded && fromRes.value && fromRes.value.emailAddress) {
                            var address2 = fromRes.value.emailAddress;
                            var domain2 = address2.substring(address2.indexOf('@') + 1);
                            callback(null, domain2, address2);
                        } else {
                            callback(new Error('No recipient address found'));
                        }
                    });
                }
            });
        }
    }

    function addJobCcWithNumber(jobNumber, domain) {
        var jobEmail = "job+" + jobNumber + "@" + domain;
        Office.context.mailbox.item.cc.setAsync(
            [{ emailAddress: jobEmail }],
            function(setResult) {
                if (setResult.status === Office.AsyncResultStatus.Failed) {
                    writeToBody(setResult.error.message);
                }
                if (Office.context.ui && Office.context.ui.closeContainer) {
                    Office.context.ui.closeContainer();
                }
            }
        );
    }

    // Set the From address to the current user's local part at the provided domain
    function setFromToDomain(domain) {
        var userEmail = Office.context.mailbox.userProfile.emailAddress || "";
        var localPart = userEmail;
        var at = userEmail.indexOf('@');
        if (at > -1) {
            localPart = userEmail.substring(0, at);
        }
        var sendAdd = localPart + "@" + domain;
        Office.context.mailbox.item.from.setAsync(
            [{ emailAddress: sendAdd }],
            function(result) {
                if (result.status === Office.AsyncResultStatus.Failed) {
                    writeToBody("Could not set 'from' address: " + result.error.message);
                }
            }
        );
    }

    function writeToBody(message) {
        Office.context.mailbox.item.body.appendOnSendAsync(
            "<div style='color:red'>Add-in error: " + message + "</div>",
            { coercionType: Office.CoercionType.Html },
            function () {}
        );
    }

</script>

</html>